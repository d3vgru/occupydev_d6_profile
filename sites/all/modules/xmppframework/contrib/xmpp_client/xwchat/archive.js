// $id archive.js

// src/xmlextras.js
eval(function(p,a,c,k,e,r){e=function(c){return(c<a?'':e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--)r[e(c)]=k[c]||e(c);k=[function(e){return r[e]}];e=function(){return'\\w+'};c=1};while(c--)if(k[c])p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c]);return p}('3 6(){}6.1a=3(){p{2(l.17){7 a=5 17();2(a.g==m){a.g=1;a.M("15",3(){a.g=4;2(G a.u=="3")a.u()},Z)}8 a}2(l.k){8 5 k(6.q()+".6")}}n(f){}t 5 r("P N L A 19 6 16");};6.q=3(){2(6.h)8 6.h;7 a=["14","13","11","10"];7 o;F(7 i=0;i<a.J;i++){p{o=5 k(a[i]+".6");8 6.h=a[i]}n(f){}}t 5 r("W A U T S R Q");};3 9(){}9.1a=3(a,b){a=a||\'1c\';b=b||\'\';p{7 c;2(C.x&&C.x.E){c=C.x.E(b,a,m);2(c.g==m){c.g=1;c.M("15",3(){c.g=4;2(G c.u=="3")c.u()},Z)}}O 2(l.k){c=5 k(9.q()+".V")}2(!c.e||c.e.1b!=a||(c.e.Y&&c.e.Y!=b)){p{2(b!=\'\')c.w(c.D(a)).18(\'K\',b);O c.w(c.D(a))}n(1s){c=C.x.E(b,a,m);2(c.e==m)c.w(c.D(a));2(b!=\'\'&&c.e.1r(\'K\')!=b){c.e.18(\'K\',b)}}}8 c}n(f){1q(f.1p+": "+f.1o)}t 5 r("P N L A 19 9 16");};9.q=3(){2(9.h)8 9.h;7 a=["14","13","11","10"];7 o;F(7 i=0;i<a.J;i++){p{o=5 k(a[i]+".V");8 9.h=a[i]}n(f){}}t 5 r("W A U T S R Q");};2(G(H)!=\'1n\'&&l.12){H.j.1l=3(s){7 a=(5 12()).1k(s,"1j/z");1i(d.1h())d.1g(d.1f);F(7 i=0;i<a.X.J;i++){d.w(d.1e(a.X[i],1m))}}}2(l.v&&l.y&&y.j&&y.j.B){1d.j.B("z",3(){8(5 v()).I(d)});H.j.B("z",3(){8(5 v()).I(d)});y.j.B("z",3(){8(5 v()).I(d)})}',62,91,'||if|function||new|XmlHttp|var|return|XmlDocument||||this|documentElement|ex|readyState|prefix||prototype|ActiveXObject|window|null|catch||try|getPrefix|Error||throw|onreadystatechange|XMLSerializer|appendChild|implementation|Node|xml|not|__defineGetter__|document|createElement|createDocument|for|typeof|Document|serializeToString|length|xmlns|does|addEventListener|browser|else|Your|parser|XML|installed|an|find|DomDocument|Could|childNodes|namespaceURI|false|MSXML3|MSXML|DOMParser|Microsoft|MSXML2|load|objects|XMLHttpRequest|setAttribute|support|create|tagName|foo|XMLDocument|importNode|lastChild|removeChild|hasChildNodes|while|text|parseFromString|loadXML|true|undefined|message|name|alert|getAttribute|dex'.split('|'),0,{}))

// src/jsextras.js
eval(function(p,a,c,k,e,r){e=function(c){return(c<a?'':e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--)r[e(c)]=k[c]||e(c);k=[function(e){return r[e]}];e=function(){return'\\w+'};c=1};while(c--)if(k[c])p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c]);return p}('U.o.S=e(){h a=d.j(/&/g,"&I;");a=a.j(/</g,"&D;");a=a.j(/>/g,"&y;");a=a.j(/\\"/g,"&v;");a=a.j(/\\n/g,"<R />");7 a};9.q=e(a){h b=p 9(9.H(a.3(0,4),a.3(5,2)-1,a.3(8,2),a.3(t,2),a.3(s,2),a.3(Q,2)));l(a.3(a.f-6,1)!=\'r\'){h c=p 9();c.m(0);c.O(a.3(a.f-5,2));c.M(a.3(a.f-2,2));l(a.3(a.f-6,1)==\'+\')b.m(b.k()-c.k());K l(a.3(a.f-6,1)==\'-\')b.m(b.k()+c.k())}7 b};9.J=e(a){7 9.q(a).G()};9.o.F=e(){h a=e(i){l(i<E)7"0"+i;7 i};h b=d.C()+"-";b+=a(d.z()+1)+"-";b+=a(d.L())+"T";b+=a(d.x())+":";b+=a(d.N())+":";b+=a(d.w())+"r";7 b};P.u=e(A,B){7(A>B)?A:B};',57,57,'|||substr||||return||Date||||this|function|length||var||replace|getTime|if|setTime||prototype|new|jab2date|Z|14|11|max|quot|getUTCSeconds|getUTCHours|gt|getUTCMonth|||getUTCFullYear|lt|10|jabberDate|toLocaleString|UTC|amp|hrTime|else|getUTCDate|setUTCMinutes|getUTCMinutes|setUTCHours|Number|17|br|htmlEnc||String'.split('|'),0,{}))

// src/JSJaCBuilder.js
eval(function(p,a,c,k,e,r){e=function(c){return(c<a?'':e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--)r[e(c)]=k[c]||e(c);k=[function(e){return r[e]}];e=function(){return'\\w+'};c=1};while(c--)if(k[c])p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c]);return p}('8 6={w:f(a,b){8 c;4(5[2])4(6.g(5[2])||(5[2]u t)){c=a.m(b);6.r(a,c,5[2])}7{4(5[2][\'p\']){H{c=a.F(5[2][\'p\'],b)}D(e){c=a.m(b)}}7 c=a.m(b);q(9 o 5[2]){4(5[2].n(9)){4(9==\'p\'&&c.z==9)y;c.x(9,5[2][9])}}}7 c=a.m(b);4(5[3])6.r(a,c,5[3]);l c},s:f(a,b){l a.J(b)},r:f(a,b,c){4(k c==\'v\'){q(8 i o c){4(c.n(i)){8 e=c[i];4(k e==\'v\'){4(e u t){8 d=6.w(a,e[0],e[1],e[2]);b.j(d)}7{b.j(e)}}7{4(6.g(e)){b.j(6.s(a,e))}}}}}7{4(6.g(c)){b.j(6.s(a,c))}}},E:f(a){8 b=[];q(h o a)4(a.n(h))b.G(h+\'="\'+a[h].C().B()+\'"\');l b.A(" ")},g:f(a){l(k a==\'I\'||k a==\'K\')}};',47,47,'||||if|arguments|JSJaCBuilder|else|var|attr||||||function|_isStringOrNumber|attribute||appendChild|typeof|return|createElement|hasOwnProperty|in|xmlns|for|_children|_text|Array|instanceof|object|buildNode|setAttribute|continue|namespaceURI|join|htmlEnc|toString|catch|_attributes|createElementNS|push|try|string|createTextNode|number'.split('|'),0,{}))

// src/JSJaCPacket.js
eval(function(p,a,c,k,e,r){e=function(c){return(c<a?'':e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--)r[e(c)]=k[c]||e(c);k=[function(e){return r[e]}];e=function(){return'\\w+'};c=1};while(c--)if(k[c])p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c]);return p}('h P=W;5 7(a){3.1t=a;8(o(P)!=\'1g\'&&P)3.B=16.1h(a,\'2g:2a\');f 3.B=16.1h(a,\'\')}7.6.21=5(){4 3.1t};7.6.g=5(){4 3.B};7.6.9=5(){8(3.g()&&3.g().1f)4 3.g().1f;f 4 x};7.6.A=5(a){8(!a||a==\'\')3.9().y(\'C\');f 8(o(a)==\'K\')3.9().n(\'C\',a);f 3.9().n(\'C\',a.14());4 3};7.6.1B=5(a){8(!a||a==\'\')3.9().y(\'J\');f 8(o(a)==\'K\')3.9().n(\'J\',a);f 3.9().n(\'J\',a.14());4 3};7.6.1x=5(a){8(!a||a==\'\')3.9().y(\'Y\');f 3.9().n(\'Y\',a);4 3};7.6.D=5(a){8(!a||a==\'\')3.9().y(\'z\');f 3.9().n(\'z\',a);4 3};7.6.23=5(a){8(!a||a==\'\')3.9().y(\'u:U\');f 3.9().n(\'u:U\',a);4 3};7.6.1m=5(){4 3.9().r(\'C\')};7.6.H=5(){4 3.9().r(\'J\')};7.6.1W=5(){4 m 1j(3.1m())};7.6.1T=5(){4 m 1j(3.H())};7.6.1S=5(){4 3.9().r(\'Y\')};7.6.1e=5(){4 3.9().r(\'z\')};7.6.1Q=5(){4 3.9().r(\'u:U\')};7.6.1P=5(){4 3.9().N};7.6.v=5(a,b){8(!3.9()){4 x}a=a||\'*\';b=b||\'*\';8(3.9().17)4 3.9().17(b,a).j(0);h c=3.9().E;G(h i=0;i<c.F;i++){8(c.j(i).1D!=1)12;8(a!=\'*\'&&c.j(i).2e!=a)12;8(b!=\'*\'&&c.j(i).N!=b){12}4 c.j(i)}4 x};7.6.t=5(a,b){h c=3.v(a,b);8(c&&c.O){4 c.O.1w}f{4\'\'}};7.6.Z=5(){4 7.1v(3.9())};7.6.25=5(){4(3.1e()==\'X\')};7.6.24=5(a){h b=3.Z();b.A(3.H());b.1B();b.D(\'X\');b.1s(\'X\',{1r:a.1r,z:a.z},[[a.22]]);4 b};7.6.u=5(){8(3.g().u)4 3.g().u;h a=(m 1q()).1p(3.9());8(o(a)!=\'1g\')4 a;4(m 1q()).1p(3.B)};7.6.1Y=5(a){4 3.9().r(a)};7.6.1n=5(a){G(h i=0;i<a.I.F;i++)8(a.I.j(i).T!=\'S\')3.9().n(a.I.j(i).T,a.I.j(i).1w);G(h i=0;i<a.E.F;i++)8(3.g().1l)3.9().k(3.g().1l(a.E.j(i),W));f 3.9().k(a.E.j(i).1X(W))};7.6.s=5(a,b){h c=3.v(a);h d=3.g().1V(b);8(c)1k{c.1U(d,c.O)}1i(e){}f{c=3.9().k(3.g().1u(a));c.k(d)}4 c};7.6.R=5(a){4 1R.R(3.g(),a,L[1],L[2])};7.6.1s=5(a){8(o a==\'Q\'){4 3.9().k(a)}f{4 3.9().k(3.R(a,L[1],L[2]))}};5 l(){3.w=7;3.w(\'1d\')}l.6=m 7;l.6.1c=5(a){3.s("1b",a);4 3};l.6.1a=5(a){3.s("13",a);4 3};l.6.19=5(a){3.s("18",a);4 3};l.6.1O=5(a,b,c){8(a)3.1a(a);8(b)3.1c(b);8(c)3.19(c);4 3};l.6.1N=5(){4 3.t(\'1b\')};l.6.1M=5(){4 3.t(\'13\')};l.6.1L=5(){4 3.t(\'18\')};5 q(){3.w=7;3.w(\'15\')}q.6=m 7;q.6.1K=5(a,b,c){8(a)3.A(a);8(b)3.D(b);8(c)3.1x(c);4 3};q.6.1J=5(a){h b;1k{b=3.g().1I(a,\'10\')}1i(e){b=3.g().1u(\'10\')}8(b&&b.r(\'S\')!=a)b.n(\'S\',a);3.9().k(b);4 b};q.6.M=5(){4 3.9().1H(\'10\').j(0)};q.6.1G=5(){8(3.M())4 3.M().N;f 4 x};q.6.1F=5(a){h b=3.Z();b.A(3.H());b.D(\'1E\');8(a){8(o a==\'K\')b.v.k(b.g().1o(a));f 8(a.1Z==20){h c=b.v();G(h i=0;i<a.F;i++)8(o a[i]==\'K\')c.k(b.g().1o(a[i]));f 8(o a[i]==\'Q\')c.k(a[i])}f 8(o a==\'Q\')b.v().k(a)}4 b};5 p(){3.w=7;3.w(\'1C\')}p.6=m 7;p.6.2f=5(a){3.s("1A",a);4 3};p.6.2d=5(a){3.s("1z",a);4 3};p.6.2b=5(a){3.s("1y",a);4 3};p.6.29=5(){4 3.t(\'1y\')};p.6.28=5(){4 3.t(\'1A\')};p.6.27=5(){4 3.t(\'1z\')};7.1v=5(a){h b;2c(a.T.26()){V\'1d\':b=m l();11;V\'1C\':b=m p();11;V\'15\':b=m q();11;2h:4 x}b.1n(a);4 b};',62,142,'|||this|return|function|prototype|JSJaCPacket|if|getNode||||||else|getDoc|var||item|appendChild|JSJaCPresence|new|setAttribute|typeof|JSJaCMessage|JSJaCIQ|getAttribute|_setChildNode|getChildVal|xml|getChild|base|null|removeAttribute|type|setTo|doc|to|setType|childNodes|length|for|getFrom|attributes|from|string|arguments|getQuery|namespaceURI|firstChild|JSJACPACKET_USE_XMLNS|object|buildNode|xmlns|nodeName|lang|case|true|error|id|clone|query|break|continue|show|toString|iq|XmlDocument|getElementsByTagNameNS|priority|setPriority|setShow|status|setStatus|presence|getType|documentElement|undefined|create|catch|JSJaCJID|try|importNode|getTo|_replaceNode|loadXML|serializeToString|XMLSerializer|code|appendNode|name|createElement|wrapNode|nodeValue|setID|thread|subject|body|setFrom|message|nodeType|result|reply|getQueryXMLNS|getElementsByTagName|createElementNS|setQuery|setIQ|getPriority|getShow|getStatus|setPresence|getXMLNS|getXMLLang|JSJaCBuilder|getID|getFromJID|replaceChild|createTextNode|getToJID|cloneNode|_getAttribute|constructor|Array|pType|cond|setXMLLang|errorReply|isError|toLowerCase|getSubject|getBody|getThread|client|setThread|switch|setSubject|tagName|setBody|jabber|default'.split('|'),0,{}))

// Archive.js start
var pWin = window.opener || window;
var jid = '', name = '', first = '', last = '', count = '';

// adding the style sheet based off the information we have in the client settings
document.write('<link rel="stylesheet" type="text/css" href="' + pWin.XC.xcfontsize + '" />');


/**
 * Set message information and then activate timeout to clear it
 * @param {String} msg The message to set
 * @action sets the message and calls the timeout to clear it
 */
function xcSetMsg(msg, error) {
  if (JQ('div#msg').children().size() > pWin.XC.LOGSIZE) {
    JQ('div#msg').children(':first-child').remove();
  }
  if (error) {
    JQ('#msg').addClass('xcError').append('<div>' + msg + '</div>').show();
  } else {
    JQ('#msg').removeClass('xcError').append('<div>' + msg + '</div>').show();
  }
};

/**
 * Posts the contents of the archive to the server
 */
function xcPostArchive() {
  if (!pWin.XC.srvUrl) { return false; };
  var body = new Array();
  var participants = new Array(jid, pWin.XC.fjid);
  // retrieve the conversation information from the window
  JQ('div#archive_conversation.xcConversationList div.xcConversationItem').each(function() {
    var name = JQ(this).find('label').html();
    var msg = JQ(this).find('span').html();
    var data = name + ' ' + msg;
    body.push(data);
  });
  // check if the timestamps were accurate if not then leave them empty
  var begin_time = new Date(JQ('div#archive_conversation.xcConversationList div.xcArchiveStartTime span').html());
  var end_time = begin_time;
  pWin.XC.pWin.$('#xcMUCPostForm #chat_type').val('single_chat');
  pWin.XC.pWin.$('#xcMUCPostForm #begin_time').val(begin_time);
  pWin.XC.pWin.$('#xcMUCPostForm #end_time').val(end_time);
  pWin.XC.pWin.$('#xcMUCPostForm #participants').val(participants.join('\r\n'));
  pWin.XC.pWin.$('#xcMUCPostForm #body').val(body.join('\r\n'));
  pWin.XC.pWin.document.forms['xcMUCPostForm'].submit();
  return false;
};

/**
 * Sends packet to request removal of conversation from the server
 * @param {String} start Start date of the conversation you wish to remove
 */
function xcArchiveDelete(start) {
  try {
    var iq = new JSJaCIQ();
    iq.setType('set');
    iq.appendNode(iq.buildNode('remove', {xmlns: pWin.NS_XEP0136NS, with: jid, start: start}));
    pWin.con.send(iq, function(iq) {
                        if (iq.isError()) {
                          xcSetMsg(pWin.xcErrorProcess(iq), true);
                          return true;
                        };
                        xcArchiveSearch(100); // refresh the message archive information
                        return true;
                      });
  } catch (e) {
    xcSetMsg(pWin.xcT('Could not remove archived conversation'), true);
  };
};

/**
 * Sends XEP-0136 request to the server to retrieve message archives for the user
 * @param {Integer} max Maximum number of records to fetch
 */
function xcArchiveSearch(max) {
  if (!max) { max = pWin.amdm; };
  JQ('form#archive_search_form input#save_button').attr('disabled', 'disabled');
  try {
    var iq = new JSJaCIQ();
    iq.setType('get');
    iq.appendNode(iq.buildNode('list', {xmlns: pWin.NS_XEP0136NS, with: jid},
                  [iq.buildNode('set', {xmlns: pWin.NS_RSM},
                  [iq.buildNode('max', max)])]));
    pWin.con.send(iq, window.xcArchiveSearchProcess);
  } catch (e) {
    xcSetMsg(e.message, true);
  };
};

/**
 * Process the reply from the archive search request
 * @param {JSJaCIQ} iq IQ packet with all pertinent information relating to the search
 */
function xcArchiveSearchProcess(iq) {
  if (iq.isError()) {
    xcSetMsg(pWin.xcErrorProcess(iq), true);
    return true;
  };
  // no children produced hence empty collection
  if (JQ(iq.getDoc()).find('list').children().size() == 0) {
    xcSetMsg(pWin.xcT('No chat records found'), true);
    return true;
  };
  // process the chat information in the system
  first = JQ(iq.getDoc()).find('first').text();
  last = JQ(iq.getDoc()).find('last').text();
  count = JQ(iq.getDoc()).find('count').text();
  var output = '';
  JQ(iq.getDoc()).find('list').children('chat').each(function() {
    if (JQ(this).attr('with') == jid) { // only process the messages associated with the person
      output = '<div id="' + JQ(this).attr('start')  + '" class="xcChatItem">' + Date.hrTime(JQ(this).attr('start')) + '</div>' + output;
    };
  });
  JQ('#archive_list').html(output);
  JQ('.xcChatItem').click(function() {
    JQ('#xcArchive .xcFieldWrapper.hidden').slideUp('fast');
    JQ('.xcConversationList').slideUp('fast');
    JQ('#xcArchive .xcChatList .xcChatItem.selected').removeClass('selected');
    JQ(this).addClass('selected');
    xcArchiveConversationGet(this.id, 100);
  });
  return true;
};

/**
 * Retrieve a specific conversation from an archive
 * @param {String} start Date of when the conversation began
 * @param {Integer} max Maximum number of records to retrieve from the conversation
 */
function xcArchiveConversationGet(start, max) {
  if (!start) { return false; };
  if (!max) { max = 100; };
  JQ('#archive_conversation').html(''); // clearing any existing archive conversations
  try {
    var iq = new JSJaCIQ();
    iq.setType('get');
    iq.appendNode(iq.buildNode('retrieve', {xmlns: pWin.NS_XEP0136NS, with: jid, start: start},
                  [iq.buildNode('set', {xmlns: pWin.NS_RSM},
                  [iq.buildNode('max', max)])]));
    pWin.con.send(iq, window.xcArchiveConversationShow);
  } catch (e) {
    xcSetMsg(e.message, true);
  };
};

/**
 * Handles the conversation and displays on the screen if data was available
 * @param {JSJaCIQ} iq Packet with the information regarding the conversation from the archive
 */
function xcArchiveConversationShow(iq) {
  if (iq.isError()) {
    xcSetMsg(pWin.xcErrorProcess(iq), true);
    return true;
  }
  // empty results set was returned, handle this
  if (JQ(iq.getDoc()).find('chat').children().size() == 0) {
    xcSetMsg(pWin.xcT('Archive empty'), true);
    return true;
  }
  // retrieve the start time for the conversation
  var output = '<div class="xcArchiveStartTime"><label>Start Time: </label><span>' + Date.hrTime(JQ(iq.getDoc()).find('chat').attr('start')) + '</span></div>';
  // results set was returned with necessary information
  JQ(iq.getDoc()).find('chat').children().each(function() {
    switch (this.nodeName.toLowerCase()) {
      case 'from':
        var secs = JQ(this).attr('secs');
        output += '<div class="xcConversationItem"><label class="received">' + name + ':</label> <span>' + JQ(this).find('body').text() + '</span></div>';
        break;
      case 'to':
        var secs = JQ(this).attr('secs');
        output += '<div class="xcConversationItem"><label class="sent">' + pWin.XC.ujid + ':</label> <span>' + JQ(this).find('body').text() + '</span></div>';
        break;
      case 'set':
        first = JQ(this).find('first').text();
        last = JQ(this).find('last').text();
        count = JQ(this).find('count').text();
        break;
      default:
        // do nothing, it is not a node we are interested in
    };
  });
  JQ('#xcArchive .xcFieldWrapper.hidden').slideDown('slow');
  JQ('#archive_conversation').html(output).slideDown('slow');
  JQ('form#archive_search_form input#save_button').removeAttr('disabled');
  return true;
}

// Runs when the DOM is ready
JQ(document).ready(function() {
  jid = JQ(document).getUrlParam('jid');
  if (!jid) {
    xcSetMsg(pWin.xcT('No Chat ID information'), true);
    setTimeout('self.close()', pWin.XC.ERRORTIMEOUT);
    return false;
  };
  // setting the click handler for the Delete button
  JQ('#remove_button').click(function() {
    if (JQ('#xcArchive .xcChatList .xcChatItem.selected').size() == 0) {
      xcSetMsg(pWin.xcT('No archive selected'), true);
      return false;
    };
    xcArchiveDelete(JQ('#xcArchive .xcChatList .xcChatItem.selected').attr('id'));
    JQ('#archive_conversation').html('');
  });
  // retrieving the name for the user so we can display in the archive
  if ((contact = pWin.xcContactExists(jid))) { name = contact.getName(); };
  JQ('#title').append(' ' + name);
  xcArchiveSearch(10000);
  // Setting click handler for the error message
  JQ('div#msg').click(function() {
    JQ(this).removeClass('xcError').html('').hide();
  });
});

JQ(window).unload(function(){
  try { pWin.xcWinClose(pWin.xcDec(self.name)); } catch (e) {};
});


