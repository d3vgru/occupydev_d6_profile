<?php
// $Id: office_html.module,v 1.2 2010/07/08 19:42:39 danepowell Exp $

/**
 * @file
 * Comments out Microsoft Office-generated HTML.
 *
 * This file is where the magic happens.
 */

/**
 * Implementation of hook_filter().
 */
function office_html_filter($op, $delta = 0, $format = -1, $text = '', $cache_id = 0) {
  switch ($op) {
    case 'list':
      return office_html_filter_list();

    case 'description':
      return office_html_filter_description($delta);

    case 'prepare':
      return office_html_filter_prepare($delta, $format, $text, $cache_id);

    default:
      return $text;
  }
}

function office_html_filter_list() {
  return array(
    0 => t('Strip style, script, and xml tags and content'),
    1 => t('Convert HTML entities to standard text'),
  );
}

function office_html_filter_description($delta = 0) {
  switch ($delta) {
    case 0:
      return t('Removes header tags (style, script, xml) and all included content, otherwise left behind by the core HTML filter.');

    case 1:
      return t('Converts HTML entities generated by Office programs into standard text entities.');
  }
}

function office_html_filter_prepare($delta = 0, $format = -1, $text = '', $cache_id = 0) {
  switch ($delta) {
    case '0':
      $text = preg_replace('/<style.*?<\/style>/xmsi', '', $text);
      $text = preg_replace('/<xml.*?<\/xml>/xmsi', '', $text);
      return preg_replace('/<script.*?<\/script>/xmsi', '', $text);
    case '1':
      $find = array('&#039;', '&#0160;', '&nbsp;', '“', '”', '’', '‘', '&rsquo;', '&lsquo;', '&ldquo;', '&rdquo;', '&mdash;', '&ndash;');
      $replace = array("'", ' ', ' ', '"', '"', "'", "'", "'", "'", '"', '"', '--', '-');
      return str_replace($find, $replace, $text);
  }
}
